<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Query</title>
</head>
<body>
    <h1>WebSocket Query</h1>
    <button onclick="sendQuery()">Send Query</button>
    <button onclick="clearResults()">Clear</button>
    <button onclick="addData()">Add Data</button>
    <button onclick="updateData()">Update Data</button>
    <button onclick="deleteData()">Delete Data</button>
    <ul id="results"></ul>

    <!-- 輸入欄位 -->
    <input type="text" id="nameInput" placeholder="Name">
    <input type="text" id="numberInput" placeholder="Number">
    <input type="number" id="priceInput" placeholder="Price">
    <input type="text" id="imagePathInput" placeholder="ImagePath">
    <input type="text" id="sizeInput" placeholder="Size">
    <input type="text" id="descriptionInput" placeholder="Description">
    <input type="text" id="materialInput" placeholder="Material">
    <input type="text" id="deleteIdInput" placeholder="deleteID">
    <input type="text" id="updateIdInput" placeholder="updateID">
    
    <input type="file" id="imageInput">
    <br>
    <br>
    <img id="imageDisplay" src="" alt="Image">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        const socket = new WebSocket('ws://118.150.125.153:8765');

        // 當接收到訊息時更新網頁內容
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                const message_type = data.type;
                const resultsList = document.getElementById('results');
                resultsList.innerHTML = data.message[2];
                
                /*if (message_type === 'query') {
                    const imageData = data.message;
                    imageData_string = imageData.substring(2, imageData.length - 2);
                    imageData_string = imageData_string.split(',')
                    imageData_string = imageData_string[9]

                    // 解碼 Base64 資料為 Uint8Array
                    const decodedData = atob(imageData_string);

                    // 將 Uint8Array 轉換為 Uint8Array 視圖
                    const uint8Array = new Uint8Array(decodedData.length);
                    for (let i = 0; i < decodedData.length; i++) {
                        uint8Array[i] = decodedData.charCodeAt(i);
                    }

                    // 建立 Blob 物件
                    const blob = new Blob([uint8Array], { type: 'image/jpeg' });

                    // 建立 URL 物件，並設置圖片的 Blob URL 作為 src
                    const imageUrl = URL.createObjectURL(blob);
                    const imageDisplay = document.getElementById('imageDisplay');
                    imageDisplay.src = imageUrl;
                }*/
                
            } catch (error) {
                console.error("Error parsing JSON:", error);
            }
        };

        // 點擊按鈕時發送訊息給伺服器
        function clearResults() {
            console.log("ClearData");
            const resultsList = document.getElementById('results');
            resultsList.innerHTML = '';
        };

        // 點擊按鈕時發送訊息給伺服器
        function sendQuery() {
            console.log("SendQuery");
            socket.send('{"type":"query"}');
        };

        // 點擊按鈕時將新資料加入伺服器
        async function addData() {
            console.log("SendAdd");

            const imageInput = document.getElementById('imageInput');
            const selectedImage = imageInput.files[0];

            const reader = new FileReader();
            reader.onload = async function(event) {
                const imageData = event.target.result;

                // 從輸入欄位獲取資料
                const name = document.getElementById('nameInput').value;
                const number = document.getElementById('numberInput').value;
                const price = document.getElementById('priceInput').value;
                const imagePath = document.getElementById('imagePathInput').value;
                const size = document.getElementById('sizeInput').value;
                const description = document.getElementById('descriptionInput').value;
                const material = document.getElementById('materialInput').value;

                // 上傳圖片到 Imgur
                const formData = new FormData();
                formData.append('image', selectedImage);

                try {
                    const imgurResponse = await fetch('https://api.imgur.com/3/image', {
                        method: 'POST',
                        headers: {
                            Authorization: 'Client-ID f46069301854f94', // Replace with your Imgur Client ID
                        },
                        body: formData,
                    });

                    if (imgurResponse.ok) {
                        const imgurData = await imgurResponse.json();
                        const imgurImageUrl = imgurData.data.link;
                        console.log('Imgur Image URL:', imgurImageUrl);

                        // 建立資料物件，包含 Imgur 圖片 URL
                        const newData = {
                            type: 'add',
                            Name: name,
                            Number: number,
                            Price: price,
                            ImagePath: imagePath,
                            Size: size,
                            Description: description,
                            Material: material,
                            ImageUrl: imgurImageUrl, // Add Imgur Image URL
                        };

                        // 將資料物件轉成 JSON 格式
                        const jsonNewData = JSON.stringify(newData);

                        // 發送資料給伺服器
                        socket.send(jsonNewData);
                    } else {
                        console.error('Imgur Upload Error:', imgurResponse.statusText);
                    }
                } catch (error) {
                    console.error('Error during Imgur upload:', error);
                }
            };

            // 讀取文件為二進制數據
            reader.readAsArrayBuffer(selectedImage);
        }

        // 點擊按鈕時向伺服器發送更新資料的請求
        function updateData() {
            console.log("SendUpdate");
            
            const imageInput = document.getElementById('imageInput');
            const selectedImage = imageInput.files[0];

            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                // 從輸入欄位獲取資料
                const name = document.getElementById('nameInput').value;
                const number = document.getElementById('numberInput').value;
                const price = document.getElementById('priceInput').value;
                const imagePath = document.getElementById('imagePathInput').value;
                const size = document.getElementById('sizeInput').value;
                const description = document.getElementById('descriptionInput').value;
                const material = document.getElementById('materialInput').value;

                // 從輸入欄位獲取要更新的資料的 ID
                const updateId = document.getElementById('updateIdInput').value;

                // 建立要傳送的資料物件
                const requestData = {
                    type: 'update',
                    id: updateId,
                    Name: name,
                    Number: number,
                    Price: price,
                    ImagePath: imagePath,
                    Size: size,
                    Description: description,
                    Material: material,
                    ImageData: imageData
                };
            
                // 將資料物件轉成 JSON 格式
                const jsonRequestData = JSON.stringify(requestData);
            
                // 發送資料給伺服器
                socket.send(jsonRequestData);
            };
            reader.readAsDataURL(selectedImage); // 读取图像文件为Base64编码
        }

        // 點擊按鈕時向伺服器發送刪除資料的請求
        function deleteData() {
            console.log("SendDelete");
            // 從輸入欄位獲取要刪除的資料的 ID
            const deleteId = document.getElementById('deleteIdInput').value;

            // 建立要傳送的資料物件
            const requestData = {
                type: 'delete',
                id: deleteId
            };

            // 將資料物件轉成 JSON 格式
            const jsonRequestData = JSON.stringify(requestData);

            // 發送資料給伺服器
            socket.send(jsonRequestData);
        }
    </script>
</body>
</html>
